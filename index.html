<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Template</title>
	<meta name="viewport" content="initial-scale=1"/>
	<link rel="stylesheet" media="screen" href="css/screen.css" >
</head>
<body id="b">
<!-- BEGIN  out-->
<div class="out">
	<!-- begin header  -->
	<div class="header">
		<h1>Sparfuchs – Kauf-Miet-Rechner</h1>
		<div class="follow">
			<span>FOLLOW US:</span> <a href="#" class="follow__fb"></a><a href="#" class="follow__tw"></a><a href="#" class="follow__rss"></a>
		</div>
		<div class="share"><i></i>Share</div>
	</div>
	<!-- end header -->
	<!-- begin l  -->
	<div class="l">
		<!-- begin l-col1  -->
		<div class="l-col1">
			<!-- begin content  -->
			<div class="content">
				<h2>Ist es besser zu Kaufen oder zu Mieten?</h2>
				<p>Die Entscheidung eine Immobilie zu kaufen ist eine der größten finanziellen Entscheidungen vieler Menschen im ganzen Leben. Bei dieser Entscheidung gehen eine Vielzahl von Faktoren ein, die bestimmen ob der Kauf einem Mietverhältnis vorzuziehen ist. Dieser Kauf-Miet-Rechner analysiert die wesentlichen Kosten die beim Kauf entstehen und errechnet die äquivalente monatliche Miete. </p>
				<div class="graph">
					<div class="graph__title"><span>Äquivalente Miete</span></div>
					<div id="test1" class="graph__el"></div>
					<div class="graph__info">
						<div class="graph__prefix">$</div>
						<span>Grunderwerbssteuer</span>
						<div class="graph__godefault"></div>
						<div class="info">
							<i class="info__ico"></i>
							<div class="info__up">
								<div class="info__content">There are many variations of passages</div>
							</div>
						</div>
					</div>
				</div>
				<h2>Kaufpreis</h2>
				<p>Ein sehr wichtiger, aber nicht der einzige relevante Faktor. Die Variablen unten werden die Entscheidung weiter verfeinern... Wenn Sie es eilig haben, reicht es wenn Sie eingeben, wie teuer der Kaufpreis ist, wie lange Sie in der Immobilie wohnen wollen und wieviel Eigenkapital Sie einbringen wollen. Für alle anderen Variablen haben wir bereits Annahmen für Sie getroffen.</p>
				<div id="test2" class="graph"></div>
				<h2>Wie lange wollen Sie die Immobilie bewohnen?</h2>
				<p>Je länger Sie in der Immobilie wohnen wollen, desto attraktiver wird der Kauf, da sich die Einmalkosten des Kaufs über viele Jahre verteilen. </p>
				<div id="test3" class="graph"></div>
				<h2>Kauf/Verkaufs-Nebenkosten</h2>
				<p>Bei Kauf und dem Verkauf einer Immobilie <br>fallen Gebühren, Steuern und Kosten an. .</p>
				<h2>Hypothek</h2>
				<p>Das eingebrachte Eigenkapital (typischerweise 20-30%), der Zinssatz und Ihre monatliche Rate bestimmt die Rückzahlungsdauer für die Hypothek
				<div class="hr"></div>
				<h2>Eckdaten der Hypothek</h2>
				<p>Gesamtvolumen der Hypothek (Kaufpreis plus Nebenkosten minus Eigenkaptital): 613‘000 EUR Entspricht einer Tilgung im ersten Jahr von: 2.09% Jahre bis zur vollständigen Tilgung der Hypothek: 24.2 Jahre.</p>
				<div class="hr"></div>
				<h2>Laufende Kosten bei Immobilieneigentum</h2>
				<p>Beim Eigentum einer Immobilie fallen Gebühren, Steuern und Kosten an.</p>
				<h2>Was bringt die Zukunft?</h2>
				<p>Die Wertentwicklung der Immobilie, Inflationsrate und die Rendite die Sie mit dem investierten Geld alternativ erwirtschaften könnten hat wesentlichen Einfluß</p>
				<h2>Kosten wenn Sie diese Immobilie mieten würden</h2>
				<p>Neben der Kaltmiete fallen dem Mieter weitere Kosten wie Makler und Kaution an. Die Kosten der Warmmiete werden nicht berücksichtigt, da diese beim Kauf ebenfalls anfallen</p>
				<h2>Methodologie</h2>
				<p>Der Kauf-Miet-Rechner berechnet den Barwert für Ihre beiden Optionen – Kauf einer Immobilie zur Eigennutzung oder Miete der Immobilie.</p>
				<p>Dabei werden die wesentlichen Kosten und Einflussgrößen berücksichtigt. Alle Größen sind als Barwerte angegeben – d.h. Zahlungsströme die in der Zukunft anfallen sind abgezinst mit der Rendite, die Sie in einer alternativen Anlage (Aktien, Anleihen,...) erwirtschaften könnten. Das ist insbesondere bedeutsam für das Eigenkapital das Sie einbringen.</p>
				<h3>Kauf</h3>
				<p><strong>Initiale Kosten</strong> sind die Kosten die beim Kauf der Immobilie anfallen. Diese beinhalten das eingebrachte Eigenkapital und die Kauf-Nebenkosten.</p>
				<p><strong>Laufende Kosten</strong> sind die Kosten die Sie beim Kauf monatlich oder jährlich tragen müssen. Diese beinhalten die Zins- und Tilgungszahlungen, Instandhaltungskosten, Grundsteuer und andere laufende Kosten.</p>
				<p><strong>Netto-Erlös</strong> ist der Betrag den Sie beim Verkauf der Immobilie erhalten, abzüglich der Verkaufskosten und der restlichen ausstehenden Hypothek. Ein negativer Betrag bedeutet, dass Sie Eigentum aufgebaut haben und verringert die Kosten des Kaufs.</p>
				<h3>Miete</h3>
				<p><strong>Initiale Kosten</strong> beinhalten die Kaution und eine mögliche Maklerprovision.</p>
				<p><strong>Laufende Kosten</strong> entsprechen dem Barwert der Kaltmiete über den Mietzeitraum.</p>
				<p><strong>Netto-Erlös</strong> der Barwert Ihrer Kaution, die Sie zum Mietende zurück erhalten.</p>
			</div>
			<!-- end content -->
		</div>
		<!-- end l-col1 -->
		<!-- begin l-col2  -->
		<div class="l-col2">
			<div class="result">
				<div class="result__b">Bei einer Miete von mehr als</div>
				<div class="result__value">
					<div class="result__valuevalue">€ 1,669</div>
					<div class="result__label">PRO<br>MONAT</div>
				</div>
				<div class="result__b">...lohnt sich der Kauf gegenüber dem Mietverhältnis</div>
				<table class="result__table">
					<thead>
						<tr>
							<th>Barwert über 40 Jahre</th>
							<td>Miete</td>
							<td>Kauf</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>Initiale Kosten</th>
							<td>€ 1,509,712</td>
							<td>€ 1,509,712</td>
						</tr>
						<tr>
							<th>Laufende Kosten</th>
							<td>€ 1,509,712</td>
							<td>€ 1,509,712</td>
						</tr>
						<tr>
							<th>Netto-Erlös</th>
							<td>€ 1,509,712</td>
							<td>€ 1,509,712</td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<th>Gesamt</th>
							<td>€ 1,509,712</td>
							<td>€ 1,509,712</td>
						</tr>
					</tfoot>
				</table>
				<p class="result__descr"><strong>Interpretation der Graphiken:</strong> Je flacher die Graphen sind, desto geringer ist der Einfluss des Faktors auf das Ergebnis. Je steiler der Graph, desto wichtiger ist der Faktor für das Ergebnis.</p>
				<div class="links">
					<a href="#" class="links__mail"></a>
					<a href="#" class="links__fb"></a>
					<a href="#" class="links__tw"></a>
					<a href="#" class="links__more"><i></i>more</a>
				</div>
			</div>
		</div>
		<!-- end l-col2 -->
	</div>
	<!-- end l -->
</div>

<!-- END out-->

<!-- d3 -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="js/lib/sticky.js"></script>
<script>
		var nytimesgraph = function (element, data, datamin, datamax, defaultvalue,postfix) {
			var that = this;

			this.scale = true;

			var rootEl = d3.select(element);
			var value = 150;


			// A formatter for counts.
			var formatCount = d3.format(",.0f");

			var margin = {top: 0, right: 30, bottom: 30, left: 180},
					width = 620 - margin.left - margin.right,
					height = 200 - margin.top - margin.bottom;

			var x = d3.scale.linear()
					.domain([0, data.length])
					.range([0, width]);

			var y = d3.scale.linear()
					.domain([0, d3.max(data)])
					.range([height, 0]);

			var valAprox = d3.scale.quantile()
					.domain([d3.min(data), d3.max(data)])
					.range(data);

			var xAxis = d3.svg.axis()
					.scale(d3.scale.linear().domain([datamin, datamax]).range([0, width]))
					.orient("bottom");

			var yAxis = d3.svg.axis()
					.scale(d3.scale.linear().domain([0, value * 2]).range([height, 0]))
					.tickSize(-width).tickSubdivide(true)
					.orient("right");

			var svg = rootEl.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var inputEl = rootEl.append("input")
					.attr("type", "text")
					.attr("class", "input-text")
					.attr('data-default',defaultvalue)
					.attr("value", defaultvalue);

			var rangeEl = rootEl.append("input")
							.attr("type", "range")
							.attr("class", "input-range")
							.attr("value", value)
							.attr("min", datamin)
							.attr("max", datamax)
							.attr('value',defaultvalue)
							.attr("step", .2);
			//.attr("min", d3.min(data))
			//.attr("max", d3.max(data))
			// то что рисует начальный график, и обновляет его масштаб
			//console.log(data);
			function render (value, options) {
				options = options || {};
				var canvas = bar;

				div = (value - datamin)/(datamax-datamin);
				nomer = Math.round(div*40);
				if(nomer>39){nomer = 39}
				if(nomer==0){}else{nomer=nomer-1;}


				value = data[nomer];
				console.log(nomer);

				if (that.scale || 1==1) {
					if (options.animate) { canvas = canvas.transition(); }

					y.domain([0, value]);

					canvas
							.attr('class', 'bar')
							.attr("transform", function (d, i) {
								return "translate(" + x(i) + "," + y(d/2) + ")";
							})


					canvas.selectAll('rect')
							.attr("height", function(d) { // Set bars height
								return height - y(d/2);
							})

					canvas
							.filter(function (d) { return - y(d) > height})
							.attr('class', 'bar over')

					canvas.select('polygon')
							.attr("points", function(d){
								var dY = - y(d/2)  ;
								return '0 '+ dY +', '+ barWidth +' '+ dY +', '+ barWidth +' '+ (dY + barWidth/2) +', '+ barWidth/2 +' '+ (dY) +', 0 '+ (dY + barWidth/2) ;
							})

					yAxis.scale(d3.scale.linear().domain([0, value * 2]).range([height, 0]));
					yAxisEl.call(yAxis);
				}

				// Set active element
				// canvas
				// 		.attr('class', "bar")
				// 		.filter(function(d){ return d == valAprox(value);})
				// 		.attr('class', "bar active");
				    //         var xReverse = d3.scale.linear()
				    //                         .range([0, data.length])
				    //                         .domain([parseInt(rangeEl.attr("min"), 10),
				    //         parseInt(rangeEl.attr("max"), 10)]);

				    //         svg.selectAll(".bar")
				    //             .filter(function(d, i){ return i == Math.round(xReverse(parseInt(inputEl[0][0].value, 10))); })
								// .attr('class', "bar active");
					updateSelected();
			}

			
			function updateSelected(){
			        svg.selectAll(".bar.active").classed("active", false);

	                var xReverse = d3.scale.linear()
	                                .range([0, data.length])
	                                .domain([parseInt(rangeEl.attr("min"), 10),
	                parseInt(rangeEl.attr("max"), 10)]);

	                svg.selectAll(".bar")
	                    .filter(function(d, i){ 
	                    	return i == Math.round(0.5+xReverse(parseInt(inputEl[0][0].value, 10)))-1;
	                    	//if(i<0){i = 0}
	                    	//return i;

	                    	 })
	    				.attr('class', "bar active");
			}

			

			var barWidth = (Math.round(width/data.length)  - 2);

			var bar = svg.selectAll(".bar")
					.data(data)
					.enter().append("g")
					.attr("class", "bar");

			bar.append("rect")
					.attr("x", 0)
					.attr("width", barWidth);


			bar.append("polygon");

			var bubbles = bar.append("g")
					.attr("class", "bubble");

			bubbles.append("use")
					.attr("xlink:href", "#bubble");

			bubbles.append("text")
					.attr("dy", ".75em")
					.attr("y", -16)
					.attr("x", barWidth/2)
					.attr("text-anchor", "middle")
					.text(function(d) { 
						//return formatCount(d);
						return d+postfix;
					});

			svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis);

			var yAxisEl = svg.append("g");

			yAxisEl
				.attr("class", "y axis")
				.attr("transform", "translate(" + width + ", 0)");
			// ====================================
			// вот тут я пытаюсь обновлять график безуспешно
			// ====================================
			this.updateme = function updateme(newdata){
				data = newdata;
	 
	            // обновляем значения data
	            svg.selectAll(".bar").data(data);
	            svg.selectAll("rect").data(data);
	            svg.selectAll(".bar text").data(data);
	 
	            // перерисовываем все с новыми значениями
	            svg.selectAll(".bar").selectAll('rect')
	                        .attr("height", function(d) { // Set bars height
	                            return height - y(d/2);
	                        });
	            svg.selectAll(".bar").attr("transform", function (d, i) {
	                            return "translate(" + x(i) + "," + y(d/2) + ")";
	                        })
	            svg.selectAll(".bar").select('polygon')
	                        .attr("points", function(d){
	                            var dY = - y(d/2)  ;
	                            return '0 '+ dY +', '+ barWidth +' '+ dY +', '+ barWidth +' '+ (dY + barWidth/2) +', '+ barWidth/2 +' '+ (dY) +', 0 '+ (dY + barWidth/2) ;
	                        })
	            svg.selectAll(".bar text").text(function(d) { return formatCount(d);});
	 
	            // valAprox тоже зависит от data
	            valAprox.domain([d3.min(data), d3.max(data)]).range(data);
	 
	            // обновляем выделенный столбик
	            svg.selectAll(".bar.active").classed("active", false);
	            // svg.selectAll(".bar")
	            //         .filter(function(d){ return d == valAprox(value); })
	            //         .attr('class', "bar active");
	    //         var xReverse = d3.scale.linear()
	    //                         .range([0, data.length])
	    //                         .domain([parseInt(rangeEl.attr("min"), 10),
	    //         parseInt(rangeEl.attr("max"), 10)]);

	    //         svg.selectAll(".bar")
	    //             .filter(function(d, i){ return i == Math.round(xReverse(parseInt(inputEl[0][0].value, 10))); })
					// .attr('class', "bar active");
					updateSelected();
			};
			// изменение значения в слайдере
			rangeEl.on("input", function(){
				var value = parseInt(rangeEl[0][0].value, 10);
				inputEl[0][0].value =  value+postfix;
				//alert(data[2]);
				// div = (value - datamin)/(datamax-datamin);
				// nomer = Math.round(div*40);
				// if(nomer>39){nomer = 39}
				// valval = data[nomer];
				
				render(value);
			});
			// rangeEl.val(defaultvalue);
			// console.log(rangeEl.val());
			// изменение значения в инпуте
			inputEl.on('change', function(){
				var value = parseInt(inputEl[0][0].value, 10) || rangeEl[0][0].value || 20;
				rangeEl[0][0].value = value;

				render(value, {animate: true});
			});

			// отрисовать начальный график
			render(value);
		};

	new nytimesgraph("#test1", d3.range(40).map(function(val, i){ return (i+1) * 8}), 1, 100, 80,'$');
	new nytimesgraph("#test2", [10, 13, 14, 15, 16, 60, 70, 71, 73, 80, 120, 121,
							133, 142, 148, 151, 152, 154, 160, 170, 171, 172,
							173, 190, 200, 300, 311, 312, 313, 314, 315, 320, 322], 100, 1000,0,'#');

	var noScaleInstanse = new nytimesgraph("#test3", d3.range(40).map(function(val, i){ return (i+1) * 8}), 20,140, 0,'-');
	noScaleInstanse.scale = false;



	// handling inputs
	$(document).ready(function() {
		$(".l-col2").sticky({topSpacing:0});
		$('body').on('change', '.input-text', function(event) {
			event.preventDefault();
			if($(this).val()!=$(this).data('default')){
				$(this).parents('.graph').addClass('is-changed');
			}
			else{
				$(this).parents('.graph').removeClass('is-changed');
			}
		});
		$('body').on('click', '.graph__godefault', function(event) {
			event.preventDefault();
			myi = $(this).parents('.graph').find('.input-text');
			myi.val(myi.data('default'));
			myi.trigger('input');
		});
		$('body').click(function(event) {
		    myd = d3.range(40).map(function(val, i){ return (i+1) * 1});
		    noScaleInstanse.updateme(myd);
		});
	});
</script>
</body>
</html>